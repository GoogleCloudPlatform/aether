module TestJsonSimple;

// IO
@extern(library="aether_runtime", symbol="aether_print")
func aether_print(s: String) -> Void;

func println(s: String) -> Void {
    aether_print(s);
    aether_print("\n");
}

// JSON
type JsonValue = String;

@extern(library="aether_runtime", symbol="parse_json")
func parse_json(json_string: String) -> JsonValue;

@extern(library="aether_runtime", symbol="json_get_field")
func json_get_field(json_value: JsonValue, field_name: String) -> JsonValue;

@extern(library="aether_runtime", symbol="to_integer")
func to_integer(json_value: JsonValue) -> Int;

// Strings
@extern(library="aether_runtime", symbol="string_length")
func string_length(s: String) -> Int;

@extern(library="aether_runtime", symbol="int_to_string")
func int_to_string(i: Int) -> String;

func main() -> Int {
    println("Start test");

    let json = "{\"x\": 42}";
    println("Parsing JSON...");

    let parsed = parse_json(json);
    println("Parsed!");

    let len = string_length(parsed);
    aether_print("Length: ");
    println(int_to_string(len));

    println("Printing parsed JSON:");
    println(parsed);

    println("Getting field x...");
    let x_val = json_get_field(parsed, "x");
    println("Got x_val");

    println("Printing x_val:");
    println(x_val);

    println("Converting to integer...");
    let x_int = to_integer(x_val);

    aether_print("x = ");
    println(int_to_string(x_int));

    if (x_int == 42) {
        println("SUCCESS!");
        return 0;
    }

    println("FAILURE");
    return 1;
}
